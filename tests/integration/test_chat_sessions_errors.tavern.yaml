---
# Chat Sessions - Error Cases and Edge Conditions

test_name: Chat Sessions - Error Handling

stages:
  # Test creating session with non-existent agent
  - name: create_session_invalid_agent
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/"
      method: POST
      headers:
        Content-Type: application/json
        Accept: application/json
        X-Forwarded-User: "test_user"
        X-Forwarded-Email: "test@example.com"
      json:
        agent_id: "00000000-0000-0000-0000-000000000000"
        session_name: "Test Session"
    response:
      status_code: [404, 400]

  # Test getting messages from non-existent session
  - name: get_messages_nonexistent_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/00000000-0000-0000-0000-000000000000/messages"
      method: GET
      headers:
        Accept: application/json
        X-Forwarded-User: "test_user"
        X-Forwarded-Email: "test@example.com"
    response:
      status_code: 404

  # Test deleting non-existent session
  - name: delete_nonexistent_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/00000000-0000-0000-0000-000000000000"
      method: DELETE
      headers:
        X-Forwarded-User: "test_user"
        X-Forwarded-Email: "test@example.com"
      params:
        agent_id: "00000000-0000-0000-0000-000000000000"
    response:
      status_code: 404

---
test_name: Chat Sessions - Empty Sessions and Message Retrieval

stages:
  # Setup: Get models
  - name: get_models
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/llama_stack/llms"
      method: GET
      headers:
        Accept: application/json
    response:
      status_code: 200
      save:
        json:
          model_name: "[0].model_name"

  # Setup: Create test agent
  - name: create_test_agent
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/virtual_agents/"
      method: POST
      headers:
        Content-Type: application/json
        Accept: application/json
      json:
        name: "Session Err Test Agent"
        prompt: "Test"
        model_name: "{model_name}"
    response:
      status_code: 201
      save:
        json:
          error_test_agent_id: "id"

  # Create empty session
  - name: create_empty_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/"
      method: POST
      headers:
        Content-Type: application/json
        Accept: application/json
        X-Forwarded-User: "error_test_user"
        X-Forwarded-Email: "error@example.com"
      json:
        agent_id: "{error_test_agent_id}"
        session_name: "Empty Session"
    response:
      status_code: 200
      save:
        json:
          empty_session_id: "id"

  # Get messages from empty session (should return empty list)
  - name: get_empty_session_messages
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/{empty_session_id}/messages"
      method: GET
      headers:
        Accept: application/json
        X-Forwarded-User: "error_test_user"
        X-Forwarded-Email: "error@example.com"
    response:
      status_code: 200
      json:
        messages: []

  # List sessions with agent_id filter
  - name: list_user_sessions_with_agent
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/"
      method: GET
      headers:
        Accept: application/json
        X-Forwarded-User: "error_test_user"
        X-Forwarded-Email: "error@example.com"
      params:
        agent_id: "{error_test_agent_id}"
        limit: 50
    response:
      status_code: 200
      json: !anylist

  # Cleanup
  - name: cleanup_empty_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/{empty_session_id}"
      method: DELETE
      headers:
        X-Forwarded-User: "error_test_user"
        X-Forwarded-Email: "error@example.com"
      params:
        agent_id: "{error_test_agent_id}"
    response:
      status_code: 200

  - name: cleanup_error_test_agent
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/virtual_agents/{error_test_agent_id}"
      method: DELETE
    response:
      status_code: 204

---
test_name: Chat Sessions - Session Deletion and Verification

stages:
  # Setup
  - name: get_models
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/llama_stack/llms"
      method: GET
      headers:
        Accept: application/json
    response:
      status_code: 200
      save:
        json:
          model_name: "[0].model_name"

  - name: create_agent_for_deletion_test
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/virtual_agents/"
      method: POST
      headers:
        Content-Type: application/json
        Accept: application/json
      json:
        name: "Deletion Test Agent"
        prompt: "Test"
        model_name: "{model_name}"
    response:
      status_code: 201
      save:
        json:
          deletion_agent_id: "id"

  # Create session
  - name: create_session_for_deletion
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/"
      method: POST
      headers:
        Content-Type: application/json
        X-Forwarded-User: "deletion_user"
        X-Forwarded-Email: "deletion@example.com"
      json:
        agent_id: "{deletion_agent_id}"
        session_name: "To Be Deleted"
    response:
      status_code: 200
      save:
        json:
          deletion_session_id: "id"

  # Delete session
  - name: delete_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/{deletion_session_id}"
      method: DELETE
      headers:
        X-Forwarded-User: "deletion_user"
        X-Forwarded-Email: "deletion@example.com"
      params:
        agent_id: "{deletion_agent_id}"
    response:
      status_code: 200

  # Verify session is deleted (should 404)
  - name: verify_deleted_session_404
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/{deletion_session_id}/messages"
      method: GET
      headers:
        Accept: application/json
        X-Forwarded-User: "deletion_user"
        X-Forwarded-Email: "deletion@example.com"
    response:
      status_code: 404

  # Try deleting already deleted session
  - name: delete_already_deleted_session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/chat_sessions/{deletion_session_id}"
      method: DELETE
      headers:
        X-Forwarded-User: "deletion_user"
        X-Forwarded-Email: "deletion@example.com"
      params:
        agent_id: "{deletion_agent_id}"
    response:
      status_code: 404

  # Cleanup
  - name: cleanup_deletion_agent
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/virtual_agents/{deletion_agent_id}"
      method: DELETE
    response:
      status_code: 204
