---
test_name: Test Users API - CRUD Workflow Integration
stages:
  - name: Create user for workflow testing
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/"
      method: POST
      headers:
        Accept: application/json
        Content-Type: application/json
      json:
        username: "workflow_user_{tavern.env_vars.TAVERN_UNIQUE}"
        email: "workflow_{tavern.env_vars.TAVERN_UNIQUE}@example.com"
        role: "user"
    response:
      status_code: 201
      save:
        json:
          workflow_user_id: "id"

  - name: Verify user persisted in database (GET)
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/{workflow_user_id}"
      method: GET
      headers:
        Accept: application/json
    response:
      status_code: 200
      json:
        id: "{workflow_user_id}"
        username: "workflow_user_{tavern.env_vars.TAVERN_UNIQUE}"
        email: "workflow_{tavern.env_vars.TAVERN_UNIQUE}@example.com"
        role: "user"
        agent_ids: !anything
        created_at: !anything
        updated_at: !anything

  - name: Update user and verify changes persist
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/{workflow_user_id}"
      method: PUT
      headers:
        Accept: application/json
        Content-Type: application/json
      json:
        username: "updated_workflow_user_{tavern.env_vars.TAVERN_UNIQUE}"
        email: "updated_workflow_{tavern.env_vars.TAVERN_UNIQUE}@example.com"
        role: "devops"
    response:
      status_code: 200
      json:
        username: "updated_workflow_user_{tavern.env_vars.TAVERN_UNIQUE}"
        email: "updated_workflow_{tavern.env_vars.TAVERN_UNIQUE}@example.com"
        role: "devops"
        agent_ids: !anything
        id: !anything
        created_at: !anything
        updated_at: !anything

  - name: Confirm update persisted by reading again
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/{workflow_user_id}"
      method: GET
    response:
      status_code: 200
      json:
        username: "updated_workflow_user_{tavern.env_vars.TAVERN_UNIQUE}"
        email: "updated_workflow_{tavern.env_vars.TAVERN_UNIQUE}@example.com"
        role: "devops"
        agent_ids: !anything
        id: !anything
        created_at: !anything
        updated_at: !anything

  - name: Delete user and verify removal
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/{workflow_user_id}"
      method: DELETE
    response:
      status_code: 204

  - name: Confirm deletion by attempting to read deleted user
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/{workflow_user_id}"
      method: GET
    response:
      status_code: 404

---
test_name: Test OAuth Session Authentication
stages:
  - name: Test OAuth authentication with admin session
    request:
      url: "{tavern.env_vars.TEST_BACKEND_URL}/api/v1/users/profile"
      method: GET
      headers:
        Cookie: "session={admin_session_cookie}"
    response:
      status_code: 200
      json:
        username: "admin"
        email: "admin@example.com"
        role: "admin"
        agent_ids: !anything
        id: !anything
        created_at: !anything
        updated_at: !anything
